<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã«ã—ã¾ã™ãƒ»ã®ã§ãƒ»ã® ç·´ç¿’ã‚²ãƒ¼ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Kaisei+Decol:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #faf6ef;
    --paper: #f2ead8;
    --ink: #1a1a2e;
    --indigo: #2c3e7a;
    --red-ink: #c0392b;
    --green-ink: #1a6b3c;
    --gold: #c9973d;
    --light-gold: #f0dba8;
    --muted: #7a6f5e;
    --border: #d4c9b0;
    --correct-bg: #e8f5ed;
    --wrong-bg: #fdecea;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background-color: var(--cream);
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(180,165,130,0.15) 27px, rgba(180,165,130,0.15) 28px),
      repeating-linear-gradient(90deg, transparent, transparent 27px, rgba(180,165,130,0.07) 27px, rgba(180,165,130,0.07) 28px);
    font-family: 'Noto Sans JP', sans-serif;
    color: var(--ink);
    min-height: 100vh;
    padding: 24px 16px 60px;
  }
  .page { max-width: 700px; margin: 0 auto; }
  header { text-align: center; margin-bottom: 20px; }
  .title-jp { font-family: 'Kaisei Decol', serif; font-size: 2rem; color: var(--indigo); letter-spacing: 0.05em; margin-bottom: 6px; }
  .subtitle { font-size: 0.78rem; color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase; }
  .grammar-tags { display: flex; justify-content: center; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
  .grammar-tag { background: var(--indigo); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }

  .accept-note {
    text-align: center; font-size: 0.76rem; color: var(--muted); margin-bottom: 16px;
    background: var(--paper); border: 1px solid var(--border); border-radius: 8px;
    padding: 7px 14px; letter-spacing: 0.03em;
  }
  .accept-note strong { color: var(--indigo); }

  .progress-bar-wrap { background: var(--border); border-radius: 8px; height: 8px; margin-bottom: 20px; overflow: hidden; }
  .progress-bar { height: 100%; background: linear-gradient(90deg, var(--indigo), var(--gold)); border-radius: 8px; transition: width 0.5s ease; }
  .progress-label { text-align: center; font-size: 0.78rem; color: var(--muted); margin-bottom: 6px; letter-spacing: 0.08em; }

  .card { background: white; border: 1.5px solid var(--border); border-radius: 12px; padding: 22px; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(44,62,122,0.06); }
  .example-card { background: var(--paper); border-color: var(--light-gold); }
  .example-label { font-size: 0.72rem; letter-spacing: 0.15em; color: var(--gold); font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }

  .vocab-row { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 16px; }
  .vocab-chip { display: inline-flex; align-items: center; gap: 4px; background: var(--cream); border: 1.5px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 0.88rem; }
  .vocab-num { font-size: 0.68rem; color: var(--gold); font-weight: 700; background: var(--light-gold); border-radius: 3px; padding: 1px 4px; }

  .dialogue { display: flex; flex-direction: column; gap: 10px; }
  .dialogue-line { display: flex; align-items: baseline; gap: 8px; line-height: 2.1; font-size: 0.97rem; flex-wrap: wrap; }
  .speaker { font-weight: 700; min-width: 26px; color: var(--indigo); font-size: 0.88rem; flex-shrink: 0; }
  .line-content { display: flex; align-items: baseline; flex-wrap: wrap; gap: 2px; flex: 1; }
  .underlined { text-decoration: underline; text-decoration-color: var(--indigo); text-underline-offset: 3px; }

  .ans-input {
    display: inline-block; border: none; border-bottom: 2px solid var(--indigo);
    background: transparent; font-family: 'Noto Sans JP', sans-serif;
    font-size: 0.93rem; color: var(--ink); outline: none; padding: 2px 4px;
    min-width: 70px; max-width: 240px; text-align: center;
    transition: border-color 0.2s, background 0.2s; border-radius: 4px 4px 0 0;
  }
  .ans-input::placeholder { color: #bbb; font-size: 0.73rem; }
  .ans-input:focus { border-bottom-color: var(--gold); background: rgba(201,151,61,0.05); }
  .ans-input.correct { border-bottom-color: var(--green-ink); background: var(--correct-bg); color: var(--green-ink); }
  .ans-input.wrong { border-bottom-color: var(--red-ink); background: var(--wrong-bg); color: var(--red-ink); animation: shake 0.3s; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

  .exercise-num { font-family: 'Kaisei Decol', serif; font-size: 1.2rem; color: var(--indigo); font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
  .exercise-num::after { content:''; flex:1; height:1px; background:var(--border); }

  .btn-row { display: flex; justify-content: center; gap: 12px; margin-top: 18px; flex-wrap: wrap; }
  .btn { font-family: 'Noto Sans JP', sans-serif; font-size: 0.88rem; font-weight: 700; padding: 10px 22px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.18s; letter-spacing: 0.05em; }
  .btn-primary { background: var(--indigo); color: white; border-color: var(--indigo); }
  .btn-primary:hover { background: #1e2b5e; }
  .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-secondary { background: transparent; color: var(--indigo); border-color: var(--border); }
  .btn-secondary:hover { border-color: var(--indigo); background: rgba(44,62,122,0.04); }
  .btn-gold { background: var(--gold); color: white; border-color: var(--gold); }
  .btn-gold:hover { background: #b5872e; }

  .hint-row { margin-top: 12px; padding: 10px 14px; background: var(--paper); border-radius: 8px; font-size: 0.82rem; color: var(--muted); display: none; line-height: 1.8; }
  .hint-row.visible { display: block; }
  .hint-correct { color: var(--green-ink); font-weight: 700; }

  .all-correct-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--correct-bg); border: 1.5px solid var(--green-ink); color: var(--green-ink); border-radius: 20px; padding: 4px 14px; font-size: 0.82rem; font-weight: 700; margin-top: 12px; opacity: 0; transition: opacity 0.3s; }
  .all-correct-badge.show { opacity: 1; }

  .score-screen { display: none; text-align: center; padding: 40px 20px; }
  .score-screen.visible { display: block; }
  .score-big { font-family: 'Kaisei Decol', serif; font-size: 4rem; color: var(--indigo); font-weight: 700; line-height: 1; margin-bottom: 8px; }
  .score-label { color: var(--muted); font-size: 0.9rem; margin-bottom: 28px; }
  .score-message { font-size: 1.2rem; font-weight: 700; color: var(--indigo); margin-bottom: 6px; }
  .score-sub { color: var(--muted); font-size: 0.85rem; margin-bottom: 32px; }
  .stamp { font-size: 4rem; display: block; margin-bottom: 8px; }
  .exercises-panel.hidden { display: none; }

  /* â”€â”€ Character popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #charPopup {
    position: fixed;
    pointer-events: none;
    z-index: 999;
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transform: scale(0.3) translateY(40px);
    transition: none;
  }
  #charPopup.show {
    animation: popIn 0.45s cubic-bezier(0.34,1.56,0.64,1) forwards;
  }
  #charPopup.hide {
    animation: popOut 0.3s ease-in forwards;
  }
  @keyframes popIn {
    0%   { opacity:0; transform: scale(0.3) translateY(40px); }
    60%  { opacity:1; transform: scale(1.12) translateY(-6px); }
    100% { opacity:1; transform: scale(1) translateY(0); }
  }
  @keyframes popOut {
    0%   { opacity:1; transform: scale(1) translateY(0); }
    100% { opacity:0; transform: scale(0.5) translateY(20px); }
  }

  .char-svg { width: 90px; height: 90px; }
  .char-label {
    margin-top: 4px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 12px;
    white-space: nowrap;
  }
  .char-label.good  { background: #c8f0d4; color: #1a6b3c; }
  .char-label.bad   { background: #fdd; color: #a02020; }

  /* wobble on wrong */
  @keyframes wobble {
    0%,100%{transform:rotate(0deg)}
    20%{transform:rotate(-12deg)}
    40%{transform:rotate(10deg)}
    60%{transform:rotate(-8deg)}
    80%{transform:rotate(6deg)}
  }
  #charPopup.wobble .char-svg { animation: wobble 0.5s ease; }

  /* bounce on correct */
  @keyframes bounce {
    0%,100%{transform:translateY(0)}
    40%{transform:translateY(-14px)}
    70%{transform:translateY(-6px)}
  }
  #charPopup.bounce .char-svg { animation: bounce 0.55s ease; }

  .back-btn {
    display: inline-flex; align-items: center; gap: 6px;
    margin-bottom: 18px;
    padding: 8px 20px;
    font-size: 0.85rem; font-weight: 600;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    background: var(--paper);
    color: var(--indigo);
    cursor: pointer;
    text-decoration: none;
    transition: background 0.15s, box-shadow 0.15s;
    box-shadow: 0 2px 8px rgba(44,62,122,0.08);
    font-family: 'Noto Sans JP', sans-serif;
  }
  .back-btn:hover {
    background: var(--light-gold);
    box-shadow: 0 4px 14px rgba(44,62,122,0.15);
  }
</style>
</head>
<body>

<!-- Character popup -->
<div id="charPopup">
  <svg id="charSvg" class="char-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>
  <div id="charLabel" class="char-label good">ã›ã„ã‹ã„ï¼</div>
</div>

<div class="page">
  <a href="index.html" class="back-btn">â† Vissza a fÅ‘oldalra</a>
  <header>
    <div class="title-jp">ç·´ç¿’ã‚²ãƒ¼ãƒ </div>
    <div class="subtitle">Japanese Grammar Practice</div>
    <div class="grammar-tags">
      <span class="grammar-tag">ã€œã«ã—ã¾ã™</span>
      <span class="grammar-tag">ã€œã®ã§</span>
      <span class="grammar-tag">ã€œã®</span>
    </div>
  </header>

  <div class="accept-note">
    ğŸ’¡ å…¥åŠ›å½¢å¼ã¯ä½•ã§ã‚‚OKï¼š<strong>ã²ã‚‰ãŒãª</strong>ãƒ»<strong>æ¼¢å­—</strong>ãƒ»<strong>ãƒ­ãƒ¼ãƒå­—</strong>ã€€ã™ã¹ã¦å—ã‘ä»˜ã‘ã¾ã™
  </div>

  <div class="card example-card">
    <div class="example-label">â–¶ ã‚Œã„ï¼ˆä¾‹ï¼‰â€” ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦‹ã¦ãã ã•ã„</div>
    <div class="vocab-row">
      <span class="vocab-chip"><span class="vocab-num">â‘ </span>ã®ã©ãŒã‹ã‚ãã¾ã—ãŸ</span>
      <span class="vocab-chip"><span class="vocab-num">â‘¡</span>ã‚³ãƒ¼ãƒ’ãƒ¼</span>
      <span class="vocab-chip"><span class="vocab-num">â‘¢</span>ã¤ã‚ãŸã„</span>
      <span class="vocab-chip"><span class="vocab-num">â‘£</span>ã‚ã¤ã„</span>
    </div>
    <div class="dialogue">
      <div class="dialogue-line"><span class="speaker">Aï¼š</span><span class="line-content">ä½•ã«ã—ã¾ã™ã‹ã€‚</span></div>
      <div class="dialogue-line"><span class="speaker">Bï¼š</span><span class="line-content"><span class="underlined">â‘ ã®ã©ãŒã‹ã‚ã„ãŸ</span>ã®ã§ã€<span class="underlined">â‘¡ã‚³ãƒ¼ãƒ’ãƒ¼</span>ã«ã—ã¾ã™ã€‚</span></div>
      <div class="dialogue-line"><span class="speaker">Aï¼š</span><span class="line-content"><span class="underlined">â‘¢ã¤ã‚ãŸã„</span>ã®ã¨ã€€<span class="underlined">â‘£ã‚ã¤ã„</span>ã®ãŒã‚ã‚Šã¾ã™ã‚ˆã€‚</span></div>
      <div class="dialogue-line"><span class="speaker">Bï¼š</span><span class="line-content">ã˜ã‚ƒã‚ã€<span class="underlined">â‘¢ã¤ã‚ãŸã„</span>ã®ã«ã—ã¾ã™ã€‚</span></div>
    </div>
  </div>

  <div class="exercises-panel" id="exercisesPanel">
    <div class="progress-label" id="progressLabel">ç·´ç¿’ 1 / 8</div>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    <div id="exerciseCard" class="card"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
      <button class="btn btn-primary" id="btnNext" onclick="nextExercise()" disabled>æ¬¡ã¸ â†’</button>
    </div>
    <div class="hint-row" id="hintRow"></div>
  </div>

  <div class="score-screen" id="scoreScreen">
    <span class="stamp" id="scoreStamp">ğŸŒ¸</span>
    <div class="score-big" id="scoreNum">0/4</div>
    <div class="score-label">æ­£è§£æ•°</div>
    <div class="score-message" id="scoreMsg"></div>
    <div class="score-sub" id="scoreSub"></div>
    <div class="btn-row"><button class="btn btn-gold" onclick="restartGame()">ã‚‚ã†ä¸€åº¦ï¼</button></div>
  </div>
</div>

<script>
// â”€â”€ Romaji â†’ Hiragana â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROMAJI_TABLE = [
  ["kkya","ã£ãã‚ƒ"],["kkyu","ã£ãã‚…"],["kkyo","ã£ãã‚‡"],
  ["sshu","ã£ã—ã‚…"],["sshi","ã£ã—"],["ssha","ã£ã—ã‚ƒ"],["ssho","ã£ã—ã‚‡"],
  ["ttchi","ã£ã¡"],["ttsu","ã£ã¤"],["ttya","ã£ã¡ã‚ƒ"],["ttyu","ã£ã¡ã‚…"],["ttyo","ã£ã¡ã‚‡"],
  ["ppya","ã£ã´ã‚ƒ"],["ppyu","ã£ã´ã‚…"],["ppyo","ã£ã´ã‚‡"],
  ["rrya","ã£ã‚Šã‚ƒ"],["rryu","ã£ã‚Šã‚…"],["rryo","ã£ã‚Šã‚‡"],
  ["kya","ãã‚ƒ"],["kyu","ãã‚…"],["kyo","ãã‚‡"],
  ["sha","ã—ã‚ƒ"],["shi","ã—"],["shu","ã—ã‚…"],["she","ã—ã‡"],["sho","ã—ã‚‡"],
  ["sya","ã—ã‚ƒ"],["syu","ã—ã‚…"],["syo","ã—ã‚‡"],
  ["chi","ã¡"],["cha","ã¡ã‚ƒ"],["chu","ã¡ã‚…"],["che","ã¡ã‡"],["cho","ã¡ã‚‡"],
  ["tchi","ã£ã¡"],["tchi","ã£ã¡"],
  ["tsu","ã¤"],["tya","ã¡ã‚ƒ"],["tyu","ã¡ã‚…"],["tyo","ã¡ã‚‡"],
  ["nya","ã«ã‚ƒ"],["nyu","ã«ã‚…"],["nyo","ã«ã‚‡"],
  ["hya","ã²ã‚ƒ"],["hyu","ã²ã‚…"],["hyo","ã²ã‚‡"],
  ["mya","ã¿ã‚ƒ"],["myu","ã¿ã‚…"],["myo","ã¿ã‚‡"],
  ["rya","ã‚Šã‚ƒ"],["ryu","ã‚Šã‚…"],["ryo","ã‚Šã‚‡"],
  ["gya","ãã‚ƒ"],["gyu","ãã‚…"],["gyo","ãã‚‡"],
  ["ja","ã˜ã‚ƒ"],["ji","ã˜"],["ju","ã˜ã‚…"],["je","ã˜ã‡"],["jo","ã˜ã‚‡"],
  ["zya","ã˜ã‚ƒ"],["zyu","ã˜ã‚…"],["zyo","ã˜ã‚‡"],
  ["bya","ã³ã‚ƒ"],["byu","ã³ã‚…"],["byo","ã³ã‚‡"],
  ["pya","ã´ã‚ƒ"],["pyu","ã´ã‚…"],["pyo","ã´ã‚‡"],
  ["dzi","ã¢"],["dzu","ã¥"],
  ["fa","ãµã"],["fi","ãµãƒ"],["fu","ãµ"],["fe","ãµã‡"],["fo","ãµã‰"],
  ["ka","ã‹"],["ki","ã"],["ku","ã"],["ke","ã‘"],["ko","ã“"],
  ["sa","ã•"],["si","ã—"],["su","ã™"],["se","ã›"],["so","ã"],
  ["ta","ãŸ"],["ti","ã¡"],["tu","ã¤"],["te","ã¦"],["to","ã¨"],
  ["na","ãª"],["ni","ã«"],["nu","ã¬"],["ne","ã­"],["no","ã®"],
  ["ha","ã¯"],["hi","ã²"],["hu","ãµ"],["he","ã¸"],["ho","ã»"],
  ["ma","ã¾"],["mi","ã¿"],["mu","ã‚€"],["me","ã‚"],["mo","ã‚‚"],
  ["ya","ã‚„"],["yu","ã‚†"],["yo","ã‚ˆ"],
  ["ra","ã‚‰"],["ri","ã‚Š"],["ru","ã‚‹"],["re","ã‚Œ"],["ro","ã‚"],
  ["wa","ã‚"],["wi","ã‚"],["we","ã‚‘"],["wo","ã‚’"],
  ["ga","ãŒ"],["gi","ã"],["gu","ã"],["ge","ã’"],["go","ã”"],
  ["za","ã–"],["zi","ã˜"],["zu","ãš"],["ze","ãœ"],["zo","ã"],
  ["da","ã "],["di","ã¢"],["du","ã¥"],["de","ã§"],["do","ã©"],
  ["ba","ã°"],["bi","ã³"],["bu","ã¶"],["be","ã¹"],["bo","ã¼"],
  ["pa","ã±"],["pi","ã´"],["pu","ã·"],["pe","ãº"],["po","ã½"],
  ["a","ã‚"],["i","ã„"],["u","ã†"],["e","ãˆ"],["o","ãŠ"],
  ["nn","ã‚“"],["n'","ã‚“"],
  ["-","ãƒ¼"],["~","ãƒ¼"],
];

function romajiToHiragana(str) {
  // handle double consonant (kkâ†’ã£k, ssâ†’ã£s, etc.) before main parse
  let s = str.toLowerCase();
  let result = '';
  let i = 0;
  while (i < s.length) {
    // special: double consonant shorthand
    if (i+1 < s.length && s[i] === s[i+1] && 'kstnhmrygzdbp'.includes(s[i])) {
      result += 'ã£';
      i++;
      continue;
    }
    // special: n before consonant or end â†’ ã‚“
    if (s[i] === 'n' && (i+1 >= s.length || (s[i+1] !== 'a' && s[i+1] !== 'i' && s[i+1] !== 'u' && s[i+1] !== 'e' && s[i+1] !== 'o' && s[i+1] !== 'y' && s[i+1] !== 'n'))) {
      result += 'ã‚“';
      i++;
      continue;
    }
    let matched = false;
    for (const [rom, hira] of ROMAJI_TABLE) {
      if (s.startsWith(rom, i)) {
        result += hira;
        i += rom.length;
        matched = true;
        break;
      }
    }
    if (!matched) { result += s[i]; i++; }
  }
  return result;
}

function katakanaToHiragana(str) {
  return str.replace(/[\u30A1-\u30F6]/g, c => String.fromCharCode(c.charCodeAt(0) - 0x60));
}

// Kanji readings for normalization
const KANJI_MAP = {
  "ä½•":"ãªã«","æ¯":"ã¯ã¯","å¦¹":"ã„ã‚‚ã†ã¨",
  "å¤§ãã„":"ãŠãŠãã„","å°ã•ã„":"ã¡ã„ã•ã„",
  "ç™½ã„":"ã—ã‚ã„","èŒ¶è‰²ã„":"ã¡ã‚ƒã„ã‚ã„",
  "é£Ÿã¹ãŸã„":"ãŸã¹ãŸã„","ç”˜ã„":"ã‚ã¾ã„",
  "è¾›ã„":"ã‹ã‚‰ã„","ç†±ã„":"ã‚ã¤ã„","å†·ãŸã„":"ã¤ã‚ãŸã„",
  "æš‘ã„":"ã‚ã¤ã„","æ¸©ã‹ã„":"ã‚ãŸãŸã‹ã„","åšã„":"ã‚ã¤ã„","è–„ã„":"ã†ã™ã„",
  "èµ¤ã„":"ã‚ã‹ã„","é’ã„":"ã‚ãŠã„","é•·ã„":"ãªãŒã„","çŸ­ã„":"ã¿ã˜ã‹ã„",
  "é£²ã¿ç‰©":"ã®ã¿ã‚‚ã®","ç‰©":"ã‚‚ã®","å‚˜":"ã‹ã•",
  "å‹ã ã¡":"ã¨ã‚‚ã ã¡","èª•ç”Ÿæ—¥":"ãŸã‚“ã˜ã‚‡ã†ã³",
  "å¤–":"ãã¨","é›¨":"ã‚ã‚","é™ã£ã¦ã„ã‚‹":"ãµã£ã¦ã„ã‚‹","é™ã£ã¦ã„ã¾ã™":"ãµã£ã¦ã„ã¾ã™",
  "å®¿é¡Œ":"ã—ã‚…ãã ã„",
  "ã¯":"ã¯","ãŒ":"ãŒ","ã‚’":"ã‚’","ã®":"ã®",
};

function applyKanjiMap(s) {
  // Sort by length desc to replace longer strings first
  const keys = Object.keys(KANJI_MAP).sort((a,b) => b.length - a.length);
  for (const k of keys) s = s.replaceAll(k, KANJI_MAP[k]);
  return s;
}

function normalize(raw) {
  if (!raw) return '';
  // full-width to half-width ascii
  let s = raw.trim()
    .replace(/\s+/g,'').replace(/ã€€/g,'')
    .replace(/[ï½-ï½šï¼¡-ï¼ºï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0)-0xFEE0))
    .toLowerCase();
  // kanji â†’ hiragana
  s = applyKanjiMap(s);
  // katakana â†’ hiragana
  s = katakanaToHiragana(s);
  // if contains mostly ascii, try romaji conversion
  const asciiCount = (s.match(/[a-z\-]/g)||[]).length;
  if (asciiCount > 0 && asciiCount / (s.length||1) > 0.3) {
    s = romajiToHiragana(s);
  }
  return s;
}

function matches(input, acceptedList) {
  const n = normalize(input);
  return acceptedList.some(a => n === normalize(a));
}

// â”€â”€ Exercises â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const exercises = [
  {
    num: 1,
    vocab: [
      {n:"â‘ ", text:"ã‚ã¾ã„ç‰©ãŒé£Ÿã¹ãŸã„ã§ã™"},
      {n:"â‘¡", text:"ã‚±ãƒ¼ã‚­"},
      {n:"â‘¢", text:"ã„ã¡ã”"},
      {n:"â‘£", text:"ã‚‚ã‚‚"},
    ],
    // answers: arrays of accepted forms per field
    answers: {
      b1r: ["ã‚ã¾ã„ã‚‚ã®ãŒãŸã¹ãŸã„","ã‚ã¾ã„ç‰©ãŒé£Ÿã¹ãŸã„","ç”˜ã„ã‚‚ã®ãŒé£Ÿã¹ãŸã„"],
      b1c: ["ã‚±ãƒ¼ã‚­","ã‘ãƒ¼ã","ke-ki","keeki"],
      a1:  ["ã„ã¡ã”","ichigo"],
      a2:  ["ã‚‚ã‚‚","momo"],
      b2:  ["ã„ã¡ã”","ichigo"],
    },
    display: {b1r:"ã‚ã¾ã„ã‚‚ã®ãŒãŸã¹ãŸã„", b1c:"ã‚±ãƒ¼ã‚­", a1:"ã„ã¡ã”", a2:"ã‚‚ã‚‚", b2:"ã„ã¡ã”"},
    hints: [
      "â‘ ã€Œã€œãŸã„ã§ã™ã€â†’ ã®ã§ ã®å‰ã¯ã€Œã€œãŸã„ã€ï¼ˆã§ã™ ã‚’å–ã‚‹ã ã‘ï¼ï¼‰",
      "ã€€ä¾‹ï¼šé£Ÿã¹ãŸã„ã§ã™ã€€â†’ã€€é£Ÿã¹ãŸã„",
      "â‘¡ã€€ã‚±ãƒ¼ã‚­",
      "â‘¢â‘£ã€€ã„ã¡ã”ã®ã¨ ã‚‚ã‚‚ã®â€¦ã€€ã©ã¡ã‚‰ã‚’é¸ã¶ï¼Ÿ",
    ]
  },
  {
    num: 2,
    vocab: [
      {n:"â‘ ", text:"ãŠãªã‹ãŒã™ãã¾ã—ãŸ"},
      {n:"â‘¡", text:"ã‚«ãƒ¬ãƒ¼"},
      {n:"â‘¢", text:"ã‹ã‚‰ã„"},
      {n:"â‘£", text:"ã‹ã‚‰ããªã„"},
    ],
    answers: {
      b1r: ["ãŠãªã‹ãŒã™ã„ãŸ","onakagasuita","ãŠãªã‹ãŒã™ãã¾ã—ãŸ"],
      b1c: ["ã‚«ãƒ¬ãƒ¼","ã‹ã‚Œãƒ¼","kare-","karee"],
      a1:  ["ã‹ã‚‰ã„","karai"],
      a2:  ["ã‹ã‚‰ããªã„","karakunai"],
      b2:  ["ã‹ã‚‰ã„","karai"],
    },
    display: {b1r:"ãŠãªã‹ãŒã™ã„ãŸ", b1c:"ã‚«ãƒ¬ãƒ¼", a1:"ã‹ã‚‰ã„", a2:"ã‹ã‚‰ããªã„", b2:"ã‹ã‚‰ã„"},
    hints: [
      "â‘ ã€Œã™ãã¾ã—ãŸã€â†’ plain pastï¼šã™ã„ãŸ",
      "ã€€ï¼ˆã™ã â†’ ã™ã„ãŸï¼‰",
      "â‘¡ã€€ã‚«ãƒ¬ãƒ¼",
      "â‘¢â‘£ã€€ã‹ã‚‰ã„ã®ã¨ ã‹ã‚‰ããªã„ã®â€¦",
    ]
  },
  {
    num: 3,
    vocab: [
      {n:"â‘ ", text:"æ¯ã¯ãŠã—ã‚ƒã‚Œã§ã™"},
      {n:"â‘¡", text:"ã‚¹ã‚«ãƒ¼ãƒ•"},
      {n:"â‘¢", text:"å¤§ãã„"},
      {n:"â‘£", text:"å°ã•ã„"},
    ],
    answers: {
      b1r: ["ã¯ã¯ã¯ãŠã—ã‚ƒã‚Œãª","æ¯ã¯ãŠã—ã‚ƒã‚Œãª","hahawaosha rena","hahawao share na","hahawaosha-rena"],
      b1c: ["ã‚¹ã‚«ãƒ¼ãƒ•","ã™ã‹ãƒ¼ãµ","suka-fu","sukafu"],
      a1:  ["ãŠãŠãã„","å¤§ãã„","ookii","ooki","Åkii"],
      a2:  ["ã¡ã„ã•ã„","å°ã•ã„","chiisai","chisai"],
      b2:  ["ãŠãŠãã„","å¤§ãã„","ookii"],
    },
    display: {b1r:"ã¯ã¯ã¯ãŠã—ã‚ƒã‚Œãª", b1c:"ã‚¹ã‚«ãƒ¼ãƒ•", a1:"ãŠãŠãã„", a2:"ã¡ã„ã•ã„", b2:"ãŠãŠãã„"},
    hints: [
      "â‘ ã€€ãªå½¢å®¹è©ã€ŒãŠã—ã‚ƒã‚Œã§ã™ã€â†’ ã®ã§ ã®å‰ï¼šã€ŒãŠã—ã‚ƒã‚Œãªã€",
      "ã€€ï¼ˆã€œã§ã™ â†’ ã€œãª ï¼‹ ã®ã§ï¼‰",
      "â‘¡ã€€ã‚¹ã‚«ãƒ¼ãƒ•",
      "â‘¢â‘£ã€€å¤§ãã„ã®ã¨ å°ã•ã„ã®â€¦",
    ]
  },
  {
    num: 4,
    vocab: [
      {n:"â‘ ", text:"ã„ã‚‚ã†ã¨ã¯å°ã•ã„ã§ã™"},
      {n:"â‘¡", text:"ã¬ã„ãã‚‹ã¿"},
      {n:"â‘¢", text:"ç™½ã„"},
      {n:"â‘£", text:"èŒ¶è‰²ã„"},
    ],
    answers: {
      b1r: ["ã„ã‚‚ã†ã¨ã¯ã¡ã„ã•ã„","å¦¹ã¯å°ã•ã„","imoutohachiisai","imoutowachisai","imoutohachiisai"],
      b1c: ["ã¬ã„ãã‚‹ã¿","nuigurumi"],
      a1:  ["ã—ã‚ã„","ç™½ã„","shiroi"],
      a2:  ["ã¡ã‚ƒã„ã‚ã„","èŒ¶è‰²ã„","chairoi"],
      b2:  ["ã—ã‚ã„","ç™½ã„","shiroi"],
    },
    display: {b1r:"ã„ã‚‚ã†ã¨ã¯ã¡ã„ã•ã„", b1c:"ã¬ã„ãã‚‹ã¿", a1:"ã—ã‚ã„", a2:"ã¡ã‚ƒã„ã‚ã„", b2:"ã—ã‚ã„"},
    hints: [
      "â‘ ã€Œå°ã•ã„ã§ã™ã€â†’ ã®ã§ ã®å‰ï¼šã€Œå°ã•ã„ã€ï¼ˆã§ã™ ã‚’å–ã‚‹ã ã‘ï¼‰",
      "â‘¡ã€€ã¬ã„ãã‚‹ã¿",
      "â‘¢â‘£ã€€ç™½ã„ã®ã¨ èŒ¶è‰²ã„ã®â€¦",
    ]
  },
  {
    num: 5,
    vocab: [
      {n:"â‘ ", text:"æš‘ï¼ˆã‚ã¤ï¼‰ã„ã§ã™"},
      {n:"â‘¡", text:"é£²ï¼ˆã®ï¼‰ã¿ç‰©ï¼ˆã‚‚ã®ï¼‰"},
      {n:"â‘¢", text:"å†·ï¼ˆã¤ã‚ï¼‰ãŸã„"},
      {n:"â‘£", text:"æ¸©ï¼ˆã‚ãŸãŸï¼‰ã‹ã„"},
    ],
    answers: {
      b1r: ["ã‚ã¤ã„","æš‘ã„","atsui"],
      b1c: ["ã®ã¿ã‚‚ã®","é£²ã¿ç‰©","nomimono"],
      a1:  ["ã¤ã‚ãŸã„","å†·ãŸã„","tsumetai"],
      a2:  ["ã‚ãŸãŸã‹ã„","æ¸©ã‹ã„","atatakai"],
      b2:  ["ã¤ã‚ãŸã„","å†·ãŸã„","tsumetai"],
    },
    display: {b1r:"ã‚ã¤ã„", b1c:"ã®ã¿ã‚‚ã®", a1:"ã¤ã‚ãŸã„", a2:"ã‚ãŸãŸã‹ã„", b2:"ã¤ã‚ãŸã„"},
    hints: [
      "â‘ ã€Œæš‘ã„ã§ã™ã€â†’ ã®ã§ ã®å‰ï¼šã€Œæš‘ã„ã€ï¼ˆã§ã™ ã‚’å–ã‚‹ã ã‘ï¼‰",
      "â‘¡ã€€é£²ã¿ç‰©ï¼ˆã®ã¿ã‚‚ã®ï¼‰",
      "â‘¢â‘£ã€€å†·ãŸã„ã®ã¨ æ¸©ã‹ã„ã®â€¦ã€€æš‘ã„ã‹ã‚‰ï¼Ÿ",
    ]
  },
  {
    num: 6,
    vocab: [
      {n:"â‘ ", text:"å‹ï¼ˆã¨ã‚‚ï¼‰ã ã¡ã®èª•ç”Ÿæ—¥ï¼ˆãŸã‚“ã˜ã‚‡ã†ã³ï¼‰ã§ã™"},
      {n:"â‘¡", text:"ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ"},
      {n:"â‘¢", text:"èµ¤ï¼ˆã‚ã‹ï¼‰ã„"},
      {n:"â‘£", text:"é’ï¼ˆã‚ãŠï¼‰ã„"},
    ],
    answers: {
      b1r: ["ã¨ã‚‚ã ã¡ã®ãŸã‚“ã˜ã‚‡ã†ã³ãª","å‹ã ã¡ã®èª•ç”Ÿæ—¥ãª","tomodachinotanjoubina","tomodachinotanjo-bina"],
      b1c: ["ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ","ã·ã‚Œãœã‚“ã¨","purezento"],
      a1:  ["ã‚ã‹ã„","èµ¤ã„","akai"],
      a2:  ["ã‚ãŠã„","é’ã„","aoi"],
      b2:  ["ã‚ã‹ã„","èµ¤ã„","akai"],
    },
    display: {b1r:"ã¨ã‚‚ã ã¡ã®ãŸã‚“ã˜ã‚‡ã†ã³ãª", b1c:"ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", a1:"ã‚ã‹ã„", a2:"ã‚ãŠã„", b2:"ã‚ã‹ã„"},
    hints: [
      "â‘ ã€€åè©ï¼‹ã§ã™ â†’ ã®ã§ ã®å‰ã¯ã€Œåè©ï¼‹ãªã€",
      "ã€€ã€Œèª•ç”Ÿæ—¥ã§ã™ã€â†’ã€Œèª•ç”Ÿæ—¥ãªã€ã®ã§",
      "â‘¡ã€€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ",
      "â‘¢â‘£ã€€èµ¤ã„ã®ã¨ é’ã„ã®â€¦",
    ]
  },
  {
    num: 7,
    vocab: [
      {n:"â‘ ", text:"å¤–ï¼ˆãã¨ï¼‰ã¯é›¨ï¼ˆã‚ã‚ï¼‰ãŒé™ï¼ˆãµï¼‰ã£ã¦ã„ã¾ã™"},
      {n:"â‘¡", text:"å‚˜ï¼ˆã‹ã•ï¼‰"},
      {n:"â‘¢", text:"é•·ï¼ˆãªãŒï¼‰ã„"},
      {n:"â‘£", text:"çŸ­ï¼ˆã¿ã˜ã‹ï¼‰ã„"},
    ],
    answers: {
      b1r: ["ãã¨ã¯ã‚ã‚ãŒãµã£ã¦ã„ã‚‹","å¤–ã¯é›¨ãŒé™ã£ã¦ã„ã‚‹","sotohaamegatutteiru","sotohaamegatsuteiru","sotohaamegatteiru"],
      b1c: ["ã‹ã•","å‚˜","kasa"],
      a1:  ["ãªãŒã„","é•·ã„","nagai"],
      a2:  ["ã¿ã˜ã‹ã„","çŸ­ã„","mijikai"],
      b2:  ["ãªãŒã„","é•·ã„","nagai"],
    },
    display: {b1r:"ãã¨ã¯ã‚ã‚ãŒãµã£ã¦ã„ã‚‹", b1c:"ã‹ã•", a1:"ãªãŒã„", a2:"ã¿ã˜ã‹ã„", b2:"ãªãŒã„"},
    hints: [
      "â‘ ã€Œã€œã¦ã„ã¾ã™ã€â†’ ã®ã§ ã®å‰ã¯plain formï¼šã€Œãµã£ã¦ã„ã‚‹ã€",
      "ã€€ï¼ˆã€œã¦ã„ã¾ã™ â†’ ã€œã¦ã„ã‚‹ï¼‰",
      "â‘¡ã€€å‚˜ï¼ˆã‹ã•ï¼‰",
      "â‘¢â‘£ã€€é•·ã„ã®ã¨ çŸ­ã„ã®â€¦ã€€é›¨ã ã‹ã‚‰ï¼Ÿ",
    ]
  },
  {
    num: 8,
    vocab: [
      {n:"â‘ ", text:"å®¿é¡Œï¼ˆã—ã‚…ãã ã„ï¼‰ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™"},
      {n:"â‘¡", text:"ãƒãƒ¼ãƒˆ"},
      {n:"â‘¢", text:"åšï¼ˆã‚ã¤ï¼‰ã„"},
      {n:"â‘£", text:"è–„ï¼ˆã†ã™ï¼‰ã„"},
    ],
    answers: {
      b1r: ["ã—ã‚…ãã ã„ãŒãŸãã•ã‚“ã‚ã‚‹","å®¿é¡ŒãŒãŸãã•ã‚“ã‚ã‚‹","shukudaigatasuksanaru","shukudaigatasanaru","shukudaigatakusanaru"],
      b1c: ["ãƒãƒ¼ãƒˆ","ã®ãƒ¼ã¨","no-to","nooto"],
      a1:  ["ã‚ã¤ã„","åšã„","atsui"],
      a2:  ["ã†ã™ã„","è–„ã„","usui"],
      b2:  ["ã‚ã¤ã„","åšã„","atsui"],
    },
    display: {b1r:"ã—ã‚…ãã ã„ãŒãŸãã•ã‚“ã‚ã‚‹", b1c:"ãƒãƒ¼ãƒˆ", a1:"ã‚ã¤ã„", a2:"ã†ã™ã„", b2:"ã‚ã¤ã„"},
    hints: [
      "â‘ ã€Œã‚ã‚Šã¾ã™ã€â†’ ã®ã§ ã®å‰ã¯plain formï¼šã€Œã‚ã‚‹ã€",
      "ã€€ï¼ˆã‚ã‚Šã¾ã™ â†’ ã‚ã‚‹ï¼‰",
      "â‘¡ã€€ãƒãƒ¼ãƒˆ",
      "â‘¢â‘£ã€€åšã„ã®ã¨ è–„ã„ã®â€¦ã€€å®¿é¡ŒãŒå¤šã„ã‹ã‚‰ï¼Ÿ",
    ]
  },
];

let current = 0, totalScore = 0, exerciseCorrect = false;

// â”€â”€ Character SVG builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flowerSVG() {
  // Happy smiling flower: petals around a face
  return `
    <!-- stem -->
    <line x1="50" y1="78" x2="50" y2="98" stroke="#4caf50" stroke-width="4" stroke-linecap="round"/>
    <line x1="50" y1="90" x2="38" y2="82" stroke="#4caf50" stroke-width="3" stroke-linecap="round"/>
    <!-- petals -->
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFD54F" transform="rotate(0,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFB74D" transform="rotate(45,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFD54F" transform="rotate(90,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFB74D" transform="rotate(135,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFD54F" transform="rotate(180,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFB74D" transform="rotate(225,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFD54F" transform="rotate(270,50,50)"/>
    <ellipse cx="50" cy="24" rx="9" ry="14" fill="#FFB74D" transform="rotate(315,50,50)"/>
    <!-- face circle -->
    <circle cx="50" cy="50" r="20" fill="#FFF176" stroke="#F9A825" stroke-width="2"/>
    <!-- sparkle eyes -->
    <circle cx="43" cy="45" r="3.5" fill="#3e2723"/>
    <circle cx="57" cy="45" r="3.5" fill="#3e2723"/>
    <circle cx="44.2" cy="43.8" r="1.2" fill="white"/>
    <circle cx="58.2" cy="43.8" r="1.2" fill="white"/>
    <!-- big smile -->
    <path d="M42 53 Q50 62 58 53" stroke="#e65100" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <!-- rosy cheeks -->
    <circle cx="40" cy="52" r="4" fill="#ffab91" opacity="0.6"/>
    <circle cx="60" cy="52" r="4" fill="#ffab91" opacity="0.6"/>
    <!-- sparkles -->
    <text x="72" y="32" font-size="12" fill="#FFC107">âœ¦</text>
    <text x="16" y="30" font-size="10" fill="#66BB6A">âœ¦</text>
  `;
}

function tanukiSVG() {
  // Sad red-faced tanuki
  return `
    <!-- body -->
    <ellipse cx="50" cy="72" rx="22" ry="18" fill="#6d4c41"/>
    <!-- tail ring -->
    <ellipse cx="50" cy="88" rx="14" ry="7" fill="#bcaaa4"/>
    <ellipse cx="50" cy="88" rx="9" ry="4" fill="#4e342e"/>
    <!-- ears -->
    <ellipse cx="30" cy="28" rx="9" ry="11" fill="#4e342e" transform="rotate(-15,30,28)"/>
    <ellipse cx="70" cy="28" rx="9" ry="11" fill="#4e342e" transform="rotate(15,70,28)"/>
    <ellipse cx="30" cy="29" rx="5" ry="7" fill="#8d6e63" transform="rotate(-15,30,29)"/>
    <ellipse cx="70" cy="29" rx="5" ry="7" fill="#8d6e63" transform="rotate(15,70,29)"/>
    <!-- head -->
    <circle cx="50" cy="45" r="26" fill="#8d6e63"/>
    <!-- red blush / flush face -->
    <circle cx="50" cy="45" r="20" fill="#e57373" opacity="0.55"/>
    <!-- raccoon eye patches -->
    <ellipse cx="39" cy="43" rx="9" ry="7" fill="#3e2723" opacity="0.75"/>
    <ellipse cx="61" cy="43" rx="9" ry="7" fill="#3e2723" opacity="0.75"/>
    <!-- sad eyes - X marks -->
    <line x1="36" y1="40" x2="42" y2="46" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="42" y1="40" x2="36" y2="46" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="58" y1="40" x2="64" y2="46" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="64" y1="40" x2="58" y2="46" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
    <!-- sad mouth -->
    <path d="M42 56 Q50 51 58 56" stroke="#3e2723" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <!-- nose -->
    <ellipse cx="50" cy="52" rx="4" ry="2.5" fill="#4e342e"/>
    <!-- whiskers -->
    <line x1="25" y1="51" x2="40" y2="53" stroke="#bcaaa4" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="25" y1="55" x2="40" y2="55" stroke="#bcaaa4" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="60" y1="53" x2="75" y2="51" stroke="#bcaaa4" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="60" y1="55" x2="75" y2="55" stroke="#bcaaa4" stroke-width="1.5" stroke-linecap="round"/>
    <!-- tear drops -->
    <ellipse cx="35" cy="52" rx="3" ry="4" fill="#90caf9" opacity="0.8"/>
    <ellipse cx="65" cy="52" rx="3" ry="4" fill="#90caf9" opacity="0.8"/>
  `;
}

// â”€â”€ Popup logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let popupTimer = null;

function showCharacter(inputEl, isCorrect) {
  const popup = document.getElementById('charPopup');
  const svg   = document.getElementById('charSvg');
  const label = document.getElementById('charLabel');

  // Position near the input field
  const rect = inputEl.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + window.scrollY;

  popup.style.left = `${cx - 45}px`;
  popup.style.top  = `${cy - 115}px`;

  svg.innerHTML = isCorrect ? flowerSVG() : tanukiSVG();
  label.textContent = isCorrect ? 'ã›ã„ã‹ã„ï¼ğŸŒ¸' : 'ã–ã‚“ã­ã‚“â€¦ğŸ˜¢';
  label.className = 'char-label ' + (isCorrect ? 'good' : 'bad');

  // Reset classes
  popup.className = '';
  void popup.offsetWidth; // force reflow
  popup.classList.add('show', isCorrect ? 'bounce' : 'wobble');

  if (popupTimer) clearTimeout(popupTimer);
  popupTimer = setTimeout(() => {
    popup.classList.remove('show','bounce','wobble');
    popup.classList.add('hide');
    popupTimer = setTimeout(() => {
      popup.className = '';
    }, 320);
  }, isCorrect ? 1600 : 1200);
}

function checkField(input) {
  const ex = exercises[current];
  const key = input.dataset.key;
  const val = input.value;
  if (!val.trim()) { input.classList.remove('correct','wrong'); return; }
  const ok = matches(val, ex.answers[key]);
  const wasWrong = input.classList.contains('wrong');
  const wasCorrect = input.classList.contains('correct');
  input.classList.toggle('correct', ok);
  input.classList.toggle('wrong', !ok);
  // show character only on state change
  if (ok && !wasCorrect) showCharacter(input, true);
  else if (!ok && !wasWrong) showCharacter(input, false);
  checkAllCorrect();
}

function checkAllCorrect() {
  const ex = exercises[current];
  const all = Object.keys(ex.answers).every(key => {
    const inp = document.querySelector(`[data-key="${key}"]`);
    return inp && matches(inp.value, ex.answers[key]);
  });
  if (all && !exerciseCorrect) {
    exerciseCorrect = true;
    totalScore++;
    document.getElementById('allCorrectBadge').classList.add('show');
    document.getElementById('btnNext').disabled = false;
    document.getElementById('hintRow').classList.remove('visible');
  }
}

function renderExercise(idx) {
  const ex = exercises[idx];
  exerciseCorrect = false;
  document.getElementById('btnNext').disabled = true;
  document.getElementById('hintRow').classList.remove('visible');
  document.getElementById('progressLabel').textContent = `ç·´ç¿’ ${idx+1} / ${exercises.length}`;
  document.getElementById('progressBar').style.width = `${(idx/exercises.length)*100}%`;

  document.getElementById('exerciseCard').innerHTML = `
    <div class="exercise-num">(${ex.num})</div>
    <div class="vocab-row">
      ${ex.vocab.map(v=>`<span class="vocab-chip"><span class="vocab-num">${v.n}</span>${v.text}</span>`).join('')}
    </div>
    <div class="dialogue">
      <div class="dialogue-line">
        <span class="speaker">Aï¼š</span>
        <span class="line-content">ä½•ã«ã—ã¾ã™ã‹ã€‚</span>
      </div>
      <div class="dialogue-line">
        <span class="speaker">Bï¼š</span>
        <span class="line-content">
          <input class="ans-input" data-key="b1r" placeholder="â‘  ã®ã§ ã®å‰â€¦" oninput="checkField(this)" style="min-width:170px">ã®ã§ã€<input class="ans-input" data-key="b1c" placeholder="â‘¡â€¦" oninput="checkField(this)" style="min-width:80px">ã«ã—ã¾ã™ã€‚
        </span>
      </div>
      <div class="dialogue-line">
        <span class="speaker">Aï¼š</span>
        <span class="line-content">
          <input class="ans-input" data-key="a1" placeholder="â‘¢â€¦" oninput="checkField(this)" style="min-width:90px">ã®ã¨ã€€<input class="ans-input" data-key="a2" placeholder="â‘£â€¦" oninput="checkField(this)" style="min-width:90px">ã®ãŒã‚ã‚Šã¾ã™ã‚ˆã€‚
        </span>
      </div>
      <div class="dialogue-line">
        <span class="speaker">Bï¼š</span>
        <span class="line-content">
          ã˜ã‚ƒã‚ã€<input class="ans-input" data-key="b2" placeholder="â‘¢â€¦" oninput="checkField(this)" style="min-width:90px">ã®ã«ã—ã¾ã™ã€‚
        </span>
      </div>
    </div>
    <div class="all-correct-badge" id="allCorrectBadge">âœ“ ã™ã°ã‚‰ã—ã„ï¼å…¨éƒ¨æ­£è§£ï¼</div>
  `;
  setTimeout(() => document.querySelector('[data-key="b1r"]').focus(), 60);
}

function showHint() {
  const ex = exercises[current];
  let html = '<strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong><br>' + ex.hints.join('<br>');
  const labels = {b1r:"â‘ ï¼ˆã®ã§å‰ï¼‰", b1c:"â‘¡", a1:"â‘¢", a2:"â‘£", b2:"â‘¢ï¼ˆBæœ€å¾Œï¼‰"};
  const wrong = Object.keys(ex.display).filter(k => {
    const inp = document.querySelector(`[data-key="${k}"]`);
    return inp && !matches(inp.value, ex.answers[k]);
  });
  if (wrong.length) {
    html += `<br><span class="hint-correct">æ­£è§£ï¼š</span> `;
    html += wrong.map(k => `<strong>${labels[k]}</strong>â†’ ${ex.display[k]}`).join('ã€€');
  }
  const row = document.getElementById('hintRow');
  row.innerHTML = html;
  row.classList.add('visible');
}

function nextExercise() {
  current++;
  if (current >= exercises.length) showScore();
  else renderExercise(current);
}

function showScore() {
  document.getElementById('exercisesPanel').classList.add('hidden');
  document.getElementById('progressBar').style.width = '100%';
  document.getElementById('scoreScreen').classList.add('visible');
  const pct = totalScore / exercises.length;
  const [stamp,msg,sub] = pct===1 ? ["ğŸŒ¸","å®Œç’§ã§ã™ï¼","å…¨å•æ­£è§£ï¼ã™ã°ã‚‰ã—ã„ï¼"]
    : pct>=0.75 ? ["â­","ã‚ˆãã§ãã¾ã—ãŸï¼","ã‚‚ã†å°‘ã—ã§æº€ç‚¹ï¼"]
    : pct>=0.5  ? ["ğŸ“","ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼","ã‚‚ã†ä¸€åº¦ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"]
    :             ["ğŸ’ª","ç·´ç¿’ãŒå¿…è¦ã§ã™ï¼","è«¦ã‚ãªã„ã§ã€ã‚‚ã†ä¸€åº¦ï¼"];
  document.getElementById('scoreStamp').textContent = stamp;
  document.getElementById('scoreNum').textContent = `${totalScore}/${exercises.length}`;
  document.getElementById('scoreMsg').textContent = msg;
  document.getElementById('scoreSub').textContent = sub;
}

function restartGame() {
  current = 0; totalScore = 0; exerciseCorrect = false;
  document.getElementById('scoreScreen').classList.remove('visible');
  document.getElementById('exercisesPanel').classList.remove('hidden');
  renderExercise(0);
}

renderExercise(0);
</script>
</body>
</html>
